<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora de Liquidación PRO | Tu Abogado Laboral</title>
    <link rel="icon" href="img/favicon.webp" type="image/webp" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Montserrat:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/style.css" />

    <style>
      :root {
        --primary: #10214b;
        --secondary: #d4af37;
        --bg-light: #f4f8fb;
        --text-dark: #333;
        --border: #e0e0e0;
      }
      body {
        font-family: "Lato", sans-serif;
        background-color: var(--bg-light);
        margin: 0;
        color: var(--text-dark);
      }
      .calc-wrapper {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }
      .calc-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(16, 33, 75, 0.05);
        border: 1px solid #e0e0e0;
        margin-bottom: 25px;
      }

      .config-bar {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }
      .config-title {
        font-weight: 900;
        color: #0d47a1;
        margin-right: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .form-grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 800px) {
        .form-grid-2,
        .form-grid-3 {
          grid-template-columns: 1fr;
        }
      }

      .form-group label {
        display: block;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 5px;
        font-size: 0.85rem;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 0.95rem;
        box-sizing: border-box;
        transition: all 0.3s;
      }

      .btn-calculate {
        background-color: var(--primary);
        color: white;
        border: none;
        width: 100%;
        padding: 16px;
        font-size: 1.1rem;
        font-weight: 900;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-calculate:hover {
        background-color: var(--secondary);
        transform: translateY(-2px);
      }

      /* GESTIÓN DE PERIODOS */
      .period-manager {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .period-header {
        background: #f1f3f5;
        padding: 15px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        color: var(--primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .period-body {
        padding: 20px;
      }

      .period-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 10px;
        align-items: end;
        margin-bottom: 15px;
      }
      .btn-add {
        background: #28a745;
        color: white;
        border: none;
        width: 42px;
        height: 38px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .btn-add:hover {
        background: #218838;
        transform: scale(1.05);
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 0.9rem;
      }
      .history-table th {
        background: #e9ecef;
        padding: 10px;
        text-align: left;
        color: #555;
      }
      .history-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      /* RESULTADOS */
      #resultsContainer {
        display: none;
        margin-top: 40px;
      }
      .report-paper {
        background: white;
        padding: 40px;
        border-radius: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #eee;
        position: relative;
      }
      .report-header-strip {
        background: var(--primary);
        color: var(--secondary);
        padding: 8px 20px;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 15px;
        border-left: 5px solid var(--secondary);
        font-size: 0.95rem;
      }
      .input-summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        font-size: 0.85rem;
      }
      .input-item label {
        display: block;
        color: #666;
        font-weight: bold;
        margin-bottom: 3px;
      }
      .input-item span {
        color: var(--primary);
        font-weight: 800;
        font-size: 1rem;
      }

      .simple-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-bottom: 20px;
      }
      .simple-table th {
        text-align: left;
        padding: 10px;
        background: #f5f5f5;
        color: #333;
        font-size: 0.85rem;
        border-bottom: 2px solid #ddd;
      }
      .simple-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
      }
      .simple-table tr:last-child td {
        border-bottom: none;
        font-weight: bold;
      }

      .total-final {
        background: #e8f5e9;
        padding: 20px;
        text-align: right;
        border-radius: 8px;
        border: 1px solid #c8e6c9;
        margin-top: 20px;
      }
      .total-amount {
        font-size: 2.2rem;
        font-weight: 900;
        color: var(--primary);
      }

      .btn-pdf {
        display: block;
        width: 250px;
        margin: 30px auto 0;
        padding: 15px;
        background: #c62828;
        color: white;
        text-align: center;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
        font-size: 1rem;
      }

      .check-group {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        gap: 10px;
        height: 42px;
        cursor: pointer;
      }
      .check-group input {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
      }
      .check-group label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9rem;
        flex-grow: 1;
      }

      .whatsapp-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #25d366;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 35px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .whatsapp-btn:hover {
        background-color: #128c7e;
        transform: scale(1.1);
      }
      /* --- CORRECCIÓN MENÚ QUIRÚRGICA PARA MÓVILES --- */
      @media (max-width: 768px) {
        header .header-container {
          position: relative; /* Referencia de posición */
        }
        /* 1. Posición Extrema Derecha y Color Azul */
        header .menu-toggle {
          position: absolute !important;
          right: 20px !important;
          top: 50% !important;
          transform: translateY(-50%) !important;
          display: block !important;
          z-index: 9999;
          font-size: 1.5rem;
          color: #10214b !important; /* Azul oscuro obligatorio */
          cursor: pointer;
        }

        /* 2. Menú Desplegable (Fondo Blanco) */
        header nav ul.nav-menu {
          display: none;
          flex-direction: column;
          width: 100%;
          position: absolute;
          top: 100%;
          left: 0;
          background-color: white;
          padding: 20px 0;
          box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
          text-align: center;
        }

        header nav ul.nav-menu.active {
          display: flex !important;
        }

        /* 3. Color de los enlaces */
        header nav ul.nav-menu li a {
          color: #10214b !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="container">
        <div class="info">
          Herramientas Jurídicas Gratuitas | Tu Abogado Laboral
        </div>
      </div>
    </div>
    <header>
      <div class="container header-container">
        <div class="logo">
          <a href="index.html"
            ><img src="img/logo-principal.webp" alt="Logo" class="logo-img"
          /></a>
        </div>
        <div class="menu-toggle" id="mobile-menu">
          <i class="fas fa-bars"></i>
        </div>
        <nav>
          <ul class="nav-menu">
            <li>
              <a href="blog.html" style="color: #10214b; font-weight: bold"
                ><i class="fas fa-arrow-left"></i> Volver a Herramientas</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <section class="bg-light" style="padding: 40px 0">
      <div class="calc-wrapper">
        <div class="text-center mb-5">
          <h1
            style="
              color: var(--primary);
              font-size: 2.2rem;
              margin-bottom: 10px;
            "
          >
            Calculadora de Liquidación PRO
          </h1>
          <p style="color: #666">
            Cálculo exacto con
            <strong>Promedios Específicos por Prestación</strong> (Art 253 CST).
          </p>
        </div>

        <form id="liqForm">
          <div class="config-bar">
            <span class="config-title"
              ><i class="fas fa-cog"></i> Legal 2026:</span
            >
            <div style="display: flex; gap: 10px; align-items: center">
              <small>SMLV</small
              ><input
                type="number"
                id="confSalarioMin"
                class="form-control"
                value="1705905"
                style="
                  width: 140px;
                  font-weight: bold;
                  color: var(--primary);
                  padding: 5px;
                "
              />
            </div>
            <div style="display: flex; gap: 10px; align-items: center">
              <small>Aux. Trans.</small
              ><input
                type="number"
                id="confAuxilio"
                class="form-control"
                value="249095"
                style="
                  width: 140px;
                  font-weight: bold;
                  color: var(--primary);
                  padding: 5px;
                "
              />
            </div>
          </div>

          <div class="calc-card">
            <h3 class="section-title">
              <i class="fas fa-file-contract"></i> 1. Datos Generales
            </h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label>Tipo de Contrato</label>
                <select id="tipoContrato" class="form-control">
                  <option value="indefinido">Término Indefinido</option>
                  <option value="fijo">Término Fijo</option>
                  <option value="obra">Obra o Labor</option>
                </select>
              </div>
              <div class="form-group">
                <label>Motivo Retiro</label>
                <select id="motivoRetiro" class="form-control">
                  <option value="voluntario">Renuncia / Mutuo Acuerdo</option>
                  <option value="justa">Despido con Justa Causa</option>
                  <option value="injusta">Despido SIN Justa Causa</option>
                </select>
              </div>
            </div>
            <div
              id="divFechaFinContrato"
              class="form-group"
              style="
                margin-top: 15px;
                display: none;
                background: #fff3e0;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid #ffe0b2;
              "
            >
              <label style="color: #e65100"
                >Fecha Fin Pactada (Para calcular meses faltantes)</label
              >
              <input type="date" id="fechaFinPactada" class="form-control" />
            </div>
          </div>

          <div class="period-manager">
            <div class="period-header">
              <span
                ><i class="fas fa-history"></i> Historial de Salarios
                (Requerido)</span
              >
            </div>
            <div class="period-body">
              <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px">
                Ingrese cada cambio de salario. El sistema usará estos datos
                para calcular la base exacta de cada prestación según su
                periodo.
              </p>

              <div class="period-row">
                <div class="form-group">
                  <label style="font-size: 0.8rem">Desde</label
                  ><input type="date" id="pInicio" class="form-control" />
                </div>
                <div class="form-group">
                  <label style="font-size: 0.8rem">Hasta</label
                  ><input type="date" id="pFin" class="form-control" />
                </div>
                <div class="form-group">
                  <label style="font-size: 0.8rem">Salario Mes</label
                  ><input
                    type="number"
                    id="pSalario"
                    class="form-control"
                    placeholder="$"
                  />
                </div>
                <div>
                  <button
                    type="button"
                    class="btn-add"
                    onclick="agregarPeriodo()"
                    title="Agregar"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>

              <table
                class="history-table"
                id="tablaPeriodos"
                style="display: none"
              >
                <thead>
                  <tr>
                    <th>Periodo</th>
                    <th>Días Calc.</th>
                    <th>Salario Mes</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div
            class="calc-card"
            style="border-left: 5px solid var(--secondary)"
          >
            <h3 class="section-title">
              <i class="fas fa-calendar-alt"></i> 2. Periodos a Liquidar
              (Específicos)
            </h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px">
              El sistema calculará el salario promedio
              <strong>exclusivamente dentro de estas fechas</strong> para cada
              concepto.
            </p>
            <div class="form-grid-3">
              <div class="form-group">
                <label>Cesantías Desde:</label
                ><input type="date" id="inicioCesantias" class="form-control" />
              </div>
              <div class="form-group">
                <label>Prima Desde:</label
                ><input type="date" id="inicioPrima" class="form-control" />
              </div>
              <div class="form-group">
                <label>Vacaciones Desde:</label
                ><input
                  type="date"
                  id="inicioVacaciones"
                  class="form-control"
                />
              </div>
            </div>

            <div
              class="form-group"
              style="
                margin-top: 20px;
                background: #f0f7ff;
                padding: 10px;
                border-radius: 6px;
              "
            >
              <label style="color: #0d47a1; font-size: 1rem"
                >Fecha de Retiro (Corte Final):</label
              >
              <input
                type="date"
                id="fechaRetiroGlobal"
                class="form-control"
                style="font-weight: bold; color: #0d47a1"
                readonly
              />
              <small
                >Se toma automáticamente del último periodo ingresado en el
                historial.</small
              >
            </div>
          </div>

          <button type="submit" id="btnCalcular" class="btn-calculate">
            <i class="fas fa-calculator"></i> Calcular Liquidación
          </button>
        </form>

        <div id="resultsContainer">
          <div class="report-paper" id="printArea">
            <div style="text-align: center; margin-bottom: 30px">
              <img
                src="img/logo-principal.webp"
                alt="Logo"
                style="height: 60px; margin-bottom: 10px"
                onerror="this.style.display = 'none'"
              />
              <h2 style="color: var(--primary); margin: 0">
                LIQUIDACIÓN FINAL DE CONTRATO
              </h2>
              <p style="color: #666; font-size: 0.9rem">
                Cálculo de bases independientes por concepto
              </p>
            </div>

            <div class="report-section">
              <div class="report-header-strip">Resumen del Contrato</div>
              <div class="input-summary-grid">
                <div class="input-item">
                  <label>Fecha Inicio:</label><span id="rFechaInicio">--</span>
                </div>
                <div class="input-item">
                  <label>Fecha Retiro:</label><span id="rFechaFin">--</span>
                </div>
                <div class="input-item">
                  <label>Motivo:</label
                  ><span id="rMotivo" style="text-transform: capitalize"
                    >--</span
                  >
                </div>
                <div class="input-item">
                  <label>Último Salario:</label
                  ><span id="rUltimoSalario">$0</span>
                </div>
              </div>
            </div>

            <div class="report-section">
              <div class="report-header-strip">
                Detalle de Prestaciones (Bases Variables)
              </div>
              <table class="simple-table">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th>Periodo Liq.</th>
                    <th>Base Salarial</th>
                    <th style="text-align: right">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>Cesantías</strong></td>
                    <td><span id="diasCesantias">0</span> días</td>
                    <td style="font-size: 0.85rem">
                      <span id="baseCesantias">$0</span> <br /><small
                        style="color: #666"
                        >(Promedio Periodo + Aux)</small
                      >
                    </td>
                    <td
                      id="valCesantias"
                      style="text-align: right; font-weight: bold"
                    >
                      $0
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <strong>Intereses Cesantías</strong><br /><small
                        >12% proporcional</small
                      >
                    </td>
                    <td><span id="diasIntereses">0</span> días</td>
                    <td>--</td>
                    <td
                      id="valIntereses"
                      style="text-align: right; font-weight: bold"
                    >
                      $0
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Prima de Servicios</strong></td>
                    <td><span id="diasPrima">0</span> días</td>
                    <td style="font-size: 0.85rem">
                      <span id="basePrima">$0</span> <br /><small
                        style="color: #666"
                        >(Promedio Periodo + Aux)</small
                      >
                    </td>
                    <td
                      id="valPrima"
                      style="text-align: right; font-weight: bold"
                    >
                      $0
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Vacaciones</strong></td>
                    <td><span id="diasVacaciones">0</span> días</td>
                    <td style="font-size: 0.85rem">
                      <span id="baseVacaciones">$0</span> <br /><small
                        style="color: #c62828"
                        >(Promedio Periodo SIN Aux)</small
                      >
                    </td>
                    <td
                      id="valVacaciones"
                      style="text-align: right; font-weight: bold"
                    >
                      $0
                    </td>
                  </tr>
                  <tr
                    id="rowIndemnizacion"
                    style="display: none; background: #fff3e0"
                  >
                    <td>
                      <strong>Indemnización Despido</strong><br /><small
                        style="color: #e65100"
                        id="descIndem"
                        >--</small
                      >
                    </td>
                    <td><span id="diasIndemnizacion">--</span></td>
                    <td style="font-size: 0.85rem">
                      <span id="baseIndem">$0</span> <br /><small
                        >(Último Salario)</small
                      >
                    </td>
                    <td
                      id="valIndemnizacion"
                      style="
                        text-align: right;
                        font-weight: bold;
                        color: #e65100;
                      "
                    >
                      $0
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="report-section">
              <div class="report-header-strip">
                Deducciones (SS Último Periodo)
              </div>
              <table class="simple-table">
                <tr>
                  <td>Salud (4%)</td>
                  <td id="dedSalud" style="text-align: right; color: #c62828">
                    $0
                  </td>
                </tr>
                <tr>
                  <td>Pensión (4%)</td>
                  <td id="dedPension" style="text-align: right; color: #c62828">
                    $0
                  </td>
                </tr>
              </table>
            </div>

            <div class="total-final">
              <span style="display: block; font-size: 1rem; color: #555"
                >TOTAL A PAGAR</span
              >
              <span id="totalNeto" class="total-amount">$0</span>
            </div>
            <p
              style="
                text-align: center;
                margin-top: 30px;
                font-size: 0.8rem;
                color: #888;
              "
            >
              * Documento generado por Tu Abogado Laboral.
            </p>
          </div>
          <button onclick="downloadPDF()" class="btn-pdf">
            <i class="fas fa-file-pdf"></i> Descargar PDF
          </button>
        </div>
      </div>
    </section>

    <div class="container" style="max-width: 1000px; margin: 0 auto">
      <div
        style="
          background-color: #fff;
          border-top: 3px solid #d4af37;
          padding: 20px;
          margin: 40px 0 20px 0;
          border-radius: 4px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
          text-align: center;
          font-size: 0.85rem;
          color: #666;
          line-height: 1.5;
        "
      >
        <p style="margin: 0">
          <strong style="color: #10214b">Aviso Legal:</strong> Herramienta de
          simulación. No reemplaza liquidación oficial.
        </p>
      </div>
    </div>

    <footer>
      <div class="container">
        <div class="footer-grid">
          <div class="footer-col">
            <div class="footer-logo">Tu Abogado <span>Laboral</span></div>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 0.9rem">
              Defensa experta y estratégica en Derecho Laboral y Pensional.
              Barranquilla, Colombia.
            </p>
            <div class="social-icons-footer">
              <a
                href="https://web.facebook.com/profile.php?id=100064878228146"
                target="_blank"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="https://www.instagram.com/tuabogadolaboralbq/"
                target="_blank"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="https://www.linkedin.com/in/dra-johana-manga-padilla-5745b542/"
                target="_blank"
                ><i class="fab fa-linkedin-in"></i
              ></a>
            </div>
          </div>

          <div class="footer-col links-col">
            <h4>Enlaces Rápidos</h4>
            <ul>
              <li><a href="index.html">Inicio</a></li>
              <li><a href="nosotros.html">Sobre Nosotros</a></li>
              <li><a href="servicios.html">Áreas de Práctica</a></li>
              <li><a href="blog.html">Herramientas</a></li>
              <li>
                <a href="contacto.html" class="active-footer">Agendar Cita</a>
              </li>
            </ul>
          </div>

          <div class="footer-col">
            <h4>Contacto</h4>
            <ul class="contact-list">
              <li>
                <i class="fas fa-map-marker-alt"></i
                ><span
                  >Edificio Las Flores, Calle 39 #43-123, Barranquilla</span
                >
              </li>
              <li>
                <i class="fas fa-phone-alt"></i><span>+57 321 792 7495</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="container copyright-flex">
          <p>© 2026 Tu Abogado Laboral - Todos los derechos reservados.</p>
          <a href="politica-privacidad.html" class="privacy-link"
            >Política de Privacidad</a
          >
        </div>
      </div>
    </footer>

    <a href="https://wa.me/573217927495" class="whatsapp-btn" target="_blank"
      ><i class="fab fa-whatsapp"></i
    ></a>

    <script>
      const formatoPeso = new Intl.NumberFormat("es-CO", {
        style: "currency",
        currency: "COP",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });

      function downloadPDF() {
        const element = document.getElementById("printArea");
        const opt = {
          margin: [0.3, 0.3, 0.3, 0.3],
          filename: "Liquidacion.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };
        html2pdf().set(opt).from(element).save();
      }

      // --- ENGINE DE FECHAS (360 Días Laborales) ---
      function calcularDias360(f1Str, f2Str) {
        if (!f1Str || !f2Str) return 0;
        const f1 = new Date(f1Str + "T00:00:00");
        const f2 = new Date(f2Str + "T00:00:00");
        if (f2 < f1) return 0;
        const Y1 = f1.getFullYear(),
          M1 = f1.getMonth() + 1,
          D1 = f1.getDate();
        const Y2 = f2.getFullYear(),
          M2 = f2.getMonth() + 1;
        let D2 = f2.getDate();
        const d1Adj = D1 === 31 ? 30 : D1;
        const d2Adj = D2 === 31 ? 30 : D2;
        return (Y2 - Y1) * 360 + (M2 - M1) * 30 + (d2Adj - d1Adj) + 1;
      }

      // --- ENGINE DE PROMEDIOS SALARIALES ---
      // Esta función es el corazón del ajuste. Calcula el salario promedio ponderado
      // SOLO dentro del rango de fechas que le pidas (ej: solo el último semestre).
      function obtenerPromedioEnRango(
        fechaInicioRango,
        fechaFinRango,
        historial,
      ) {
        if (!historial || historial.length === 0) return 0;

        let sumaSalarios = 0;
        let diasTotalesRango = 0;

        // Convertir strings a Dates para comparación
        const rangoIni = new Date(fechaInicioRango + "T00:00:00");
        const rangoFin = new Date(fechaFinRango + "T00:00:00");

        historial.forEach((p) => {
          const pIni = new Date(p.ini + "T00:00:00");
          const pFin = new Date(p.fin + "T00:00:00");

          // Verificar Intersección de Periodos
          // El periodo debe terminar después de que el rango empiece Y empezar antes de que el rango termine
          if (pFin >= rangoIni && pIni <= rangoFin) {
            // Determinar los límites reales de la intersección
            const inicioReal = pIni < rangoIni ? rangoIni : pIni;
            const finReal = pFin > rangoFin ? rangoFin : pFin;

            // Calcular días de ese fragmento
            const diasFragmento = calcularDias360(
              inicioReal.toISOString().split("T")[0],
              finReal.toISOString().split("T")[0],
            );

            if (diasFragmento > 0) {
              sumaSalarios += p.sal * diasFragmento;
              diasTotalesRango += diasFragmento;
            }
          }
        });

        if (diasTotalesRango === 0) return 0;
        return sumaSalarios / diasTotalesRango;
      }

      // --- LOGICA UI ---
      let periodos = [];
      const els = {
        pInicio: document.getElementById("pInicio"),
        pFin: document.getElementById("pFin"),
        pSalario: document.getElementById("pSalario"),
        smlv: document.getElementById("confSalarioMin"),
        aux: document.getElementById("confAuxilio"),
        fRetiroGlobal: document.getElementById("fechaRetiroGlobal"),
      };

      function agregarPeriodo() {
        const ini = els.pInicio.value;
        const fin = els.pFin.value;
        const sal = parseFloat(els.pSalario.value);
        if (!ini || !fin || !sal) return alert("Datos incompletos");
        if (new Date(ini) > new Date(fin))
          return alert("Fecha inicio mayor a fin");

        periodos.push({ ini, fin, sal });
        periodos.sort((a, b) => new Date(a.ini) - new Date(b.ini));

        renderPeriodos();

        // Auto-llenar fechas sugeridas basado en el historial completo
        const fInicioTotal = periodos[0].ini;
        const fFinTotal = periodos[periodos.length - 1].fin;

        els.fRetiroGlobal.value = fFinTotal;

        if (!document.getElementById("inicioCesantias").value)
          document.getElementById("inicioCesantias").value = fInicioTotal;
        if (!document.getElementById("inicioPrima").value)
          document.getElementById("inicioPrima").value = fInicioTotal;
        if (!document.getElementById("inicioVacaciones").value)
          document.getElementById("inicioVacaciones").value = fInicioTotal;

        els.pInicio.value = "";
        els.pFin.value = "";
        els.pSalario.value = "";
      }

      function eliminarPeriodo(idx) {
        periodos.splice(idx, 1);
        renderPeriodos();
      }

      function renderPeriodos() {
        const tbody = document.querySelector("#tablaPeriodos tbody");
        tbody.innerHTML = "";
        if (periodos.length > 0) {
          document.getElementById("tablaPeriodos").style.display = "table";
          periodos.forEach((p, i) => {
            tbody.innerHTML += `<tr><td>${p.ini} a ${
              p.fin
            }</td><td>${calcularDias360(
              p.ini,
              p.fin,
            )}</td><td>${formatoPeso.format(
              p.sal,
            )}</td><td><button type="button" class="btn-delete" onclick="eliminarPeriodo(${i})"><i class="fas fa-trash"></i></button></td></tr>`;
          });
        } else document.getElementById("tablaPeriodos").style.display = "none";
      }

      // --- VISIBILIDAD INDEMNIZACION ---
      const domMotivo = document.getElementById("motivoRetiro");
      const domTipo = document.getElementById("tipoContrato");
      function checkUI() {
        const show =
          domMotivo.value === "injusta" &&
          (domTipo.value === "fijo" || domTipo.value === "obra");
        document.getElementById("divFechaFinContrato").style.display = show
          ? "block"
          : "none";
      }
      domMotivo.addEventListener("change", checkUI);
      domTipo.addEventListener("change", checkUI);

      // --- CÁLCULO INDEMNIZACIÓN ---
      function calcularIndemnizacion(
        tipo,
        salarioBase,
        diasTotales,
        fFin,
        fPactada,
        smlv,
      ) {
        if (tipo === "fijo" || tipo === "obra") {
          if (!fPactada)
            return { dias: 0, valor: 0, desc: "Falta fecha pactada" };
          const diasFaltantes = calcularDias360(fFin, fPactada) - 1;
          if (diasFaltantes <= 0)
            return { dias: 0, valor: 0, desc: "Contrato vencido" };
          return {
            dias: diasFaltantes,
            valor: (salarioBase / 30) * diasFaltantes,
            desc: "Salarios faltantes",
          };
        } else {
          // INDEFINIDO
          let diasIndem = 0;
          if (salarioBase < smlv * 10) {
            if (diasTotales <= 360) diasIndem = (30 * diasTotales) / 360;
            else diasIndem = 30 + ((diasTotales - 360) * 20) / 360;
          } else {
            if (diasTotales <= 360) diasIndem = (20 * diasTotales) / 360;
            else diasIndem = 20 + ((diasTotales - 360) * 15) / 360;
          }
          return {
            dias: diasIndem.toFixed(2),
            valor: (salarioBase / 30) * diasIndem,
            desc: "Art. 64 CST",
          };
        }
      }

      // --- SUBMIT ---
      document
        .getElementById("liqForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (periodos.length === 0)
            return alert("Debe ingresar el historial salarial.");
          const btn = document.getElementById("btnCalcular");
          const originalText = btn.innerHTML;
          btn.innerHTML = "Calculando...";

          try {
            const setText = (id, val) => {
              const el = document.getElementById(id);
              if (el) el.textContent = val;
            };
            const fRetiro = els.fRetiroGlobal.value;
            const smlv = parseFloat(els.smlv.value) || 0;
            const auxLegal = parseFloat(els.aux.value) || 0;

            // 1. Obtener Fechas de Inicio de cada concepto
            const iniCes = document.getElementById("inicioCesantias").value;
            const iniPri = document.getElementById("inicioPrima").value;
            const iniVac = document.getElementById("inicioVacaciones").value;
            // Fecha inicio total para indemnización y datos generales
            const iniTotal = periodos[0].ini;

            // 2. CALCULAR PROMEDIOS ESPECÍFICOS (Aquí está la corrección clave)
            const salarioPromedioCes = obtenerPromedioEnRango(
              iniCes,
              fRetiro,
              periodos,
            );
            const salarioPromedioPri = obtenerPromedioEnRango(
              iniPri,
              fRetiro,
              periodos,
            );
            const salarioPromedioVac = obtenerPromedioEnRango(
              iniVac,
              fRetiro,
              periodos,
            );

            // Último salario (para indemnización y deducciones)
            const ultimoSalario = periodos[periodos.length - 1].sal;

            // 3. DETERMINAR BASES CON AUXILIO
            // Para cada concepto, verificamos si SU promedio + Aux aplica
            // Regla: Se paga auxilio si el promedio devengado <= 2 SMLV

            const baseCes =
              salarioPromedioCes +
              (salarioPromedioCes <= smlv * 2 ? auxLegal : 0);
            const basePri =
              salarioPromedioPri +
              (salarioPromedioPri <= smlv * 2 ? auxLegal : 0);
            const baseVac = salarioPromedioVac; // Vacaciones NUNCA llevan auxilio

            // 4. DIAS
            const diasCes = calcularDias360(iniCes, fRetiro);
            const diasPri = calcularDias360(iniPri, fRetiro);
            const diasVac = calcularDias360(iniVac, fRetiro);
            const diasTotales = calcularDias360(iniTotal, fRetiro);

            // 5. VALORES
            const valCes = (baseCes * diasCes) / 360;
            const valInt = (valCes * diasCes * 0.12) / 360;
            const valPri = (basePri * diasPri) / 360;
            const valVac = (baseVac * diasVac) / 720;

            // Indemnización (Base Último Salario)
            let valIndem = 0;
            if (domMotivo.value === "injusta") {
              document.getElementById("rowIndemnizacion").style.display =
                "table-row";
              const res = calcularIndemnizacion(
                domTipo.value,
                ultimoSalario,
                diasTotales,
                fRetiro,
                document.getElementById("fechaFinPactada").value,
                smlv,
              );
              valIndem = res.valor;
              setText("diasIndemnizacion", res.dias);
              setText("valIndemnizacion", formatoPeso.format(valIndem));
              setText("descIndem", res.desc);
              setText("baseIndem", formatoPeso.format(ultimoSalario));
            } else {
              document.getElementById("rowIndemnizacion").style.display =
                "none";
            }

            const subtotal = valCes + valInt + valPri + valVac + valIndem;

            // Deducciones (Sobre último salario real proporcional al mes de retiro)
            // Asumimos mes de 30 días para la proporción de seguridad social de salida
            const dateRetiro = new Date(fRetiro);
            const diaRetiro =
              dateRetiro.getDate() === 31 ? 30 : dateRetiro.getDate();
            const ibcSalida = (ultimoSalario / 30) * diaRetiro;
            const ded = ibcSalida * 0.04 * 2; // 4% salud + 4% pension
            const neto = subtotal - ded;

            // RENDER
            setText("rFechaInicio", iniTotal);
            setText("rFechaFin", fRetiro);
            setText("rMotivo", domMotivo.options[domMotivo.selectedIndex].text);
            setText("rUltimoSalario", formatoPeso.format(ultimoSalario));

            setText("diasCesantias", diasCes);
            setText("baseCesantias", formatoPeso.format(baseCes));
            setText("valCesantias", formatoPeso.format(valCes));
            setText("diasIntereses", diasCes);
            setText("valIntereses", formatoPeso.format(valInt));
            setText("diasPrima", diasPri);
            setText("basePrima", formatoPeso.format(basePri));
            setText("valPrima", formatoPeso.format(valPri));
            setText("diasVacaciones", diasVac);
            setText("baseVacaciones", formatoPeso.format(baseVac));
            setText("valVacaciones", formatoPeso.format(valVac));

            setText("dedSalud", "-" + formatoPeso.format(ibcSalida * 0.04));
            setText("dedPension", "-" + formatoPeso.format(ibcSalida * 0.04));
            setText("totalNeto", formatoPeso.format(Math.max(0, neto)));

            const results = document.getElementById("resultsContainer");
            results.style.display = "block";
            results.scrollIntoView({ behavior: "smooth" });
          } catch (e) {
            alert(e.message);
          } finally {
            setTimeout(() => (btn.innerHTML = originalText), 500);
          }
        });
    </script>
  </body>
</html>
